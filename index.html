<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>推し焼酎　問診表</title>
  <style>
    body {
      font-family: system-ui, sans-serif;
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
      line-height: 1.6;
    }
    h1, h2, h3 { text-align: center; }
    .hidden { display: none; }
    .center { text-align: center; }

    .type-buttons button,
    .answer-buttons button,
    #nextButton,
    #backButton,
    #restartButton,
    #startButton,
    #typeNextButton,
    #saveTxtButton {
      margin: 5px;
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
    }

    .question-box, .result-box, .setup-box {
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 16px;
      margin-top: 20px;
    }

    .result-box img {
      max-width: 100%;
      height: auto;
      display: block;
      margin: 10px auto;
    }

    .answer-buttons button.selected,
    .type-buttons button.selected {
      background-color: #333;
      color: #fff;
    }

    .nav-buttons { margin-top: 12px; }
    #resultText { white-space: pre-wrap; }

    .form-row {
      display: grid;
      grid-template-columns: 160px 1fr;
      gap: 10px;
      align-items: center;
      margin: 10px 0;
    }

    select, input {
      font-size: 16px;
      padding: 8px;
    }

    .small-note {
      font-size: 12px;
      color: #555;
      margin-top: 6px;
    }
  </style>
</head>
<body>

  <h1>推し焼酎発見！</h1>

  <!-- ステップ0：属性入力（年代・性別・都道府県） -->
  <section id="setupSection">
    <h2>診断の前に教えてください</h2>
    <div class="setup-box">
      <div class="form-row">
        <label for="ageSelect">年代</label>
        <select id="ageSelect">
          <option value="">選択してください</option>
          <option value="10代">10代</option>
          <option value="20代">20代</option>
          <option value="30代">30代</option>
          <option value="40代">40代</option>
          <option value="50代">50代</option>
          <option value="60代">60代</option>
          <option value="70代以上">70代以上</option>
        </select>
      </div>

      <div class="form-row">
        <label for="genderSelect">性別</label>
        <select id="genderSelect">
          <option value="">選択してください</option>
          <option value="男性">男性</option>
          <option value="女性">女性</option>
          <option value="その他/回答しない">その他/回答しない</option>
        </select>
      </div>

      <div class="form-row">
        <label for="prefSelect">お住まい（都道府県）</label>
        <!-- 都道府県はHTML直書き（SharePoint等でJSが止まっても選択できる） -->
        <select id="prefSelect">
          <option value="">選択してください</option>
          <option value="北海道">北海道</option>
          <option value="青森県">青森県</option>
          <option value="岩手県">岩手県</option>
          <option value="宮城県">宮城県</option>
          <option value="秋田県">秋田県</option>
          <option value="山形県">山形県</option>
          <option value="福島県">福島県</option>
          <option value="茨城県">茨城県</option>
          <option value="栃木県">栃木県</option>
          <option value="群馬県">群馬県</option>
          <option value="埼玉県">埼玉県</option>
          <option value="千葉県">千葉県</option>
          <option value="東京都">東京都</option>
          <option value="神奈川県">神奈川県</option>
          <option value="新潟県">新潟県</option>
          <option value="富山県">富山県</option>
          <option value="石川県">石川県</option>
          <option value="福井県">福井県</option>
          <option value="山梨県">山梨県</option>
          <option value="長野県">長野県</option>
          <option value="岐阜県">岐阜県</option>
          <option value="静岡県">静岡県</option>
          <option value="愛知県">愛知県</option>
          <option value="三重県">三重県</option>
          <option value="滋賀県">滋賀県</option>
          <option value="京都府">京都府</option>
          <option value="大阪府">大阪府</option>
          <option value="兵庫県">兵庫県</option>
          <option value="奈良県">奈良県</option>
          <option value="和歌山県">和歌山県</option>
          <option value="鳥取県">鳥取県</option>
          <option value="島根県">島根県</option>
          <option value="岡山県">岡山県</option>
          <option value="広島県">広島県</option>
          <option value="山口県">山口県</option>
          <option value="徳島県">徳島県</option>
          <option value="香川県">香川県</option>
          <option value="愛媛県">愛媛県</option>
          <option value="高知県">高知県</option>
          <option value="福岡県">福岡県</option>
          <option value="佐賀県">佐賀県</option>
          <option value="長崎県">長崎県</option>
          <option value="熊本県">熊本県</option>
          <option value="大分県">大分県</option>
          <option value="宮崎県">宮崎県</option>
          <option value="鹿児島県">鹿児島県</option>
          <option value="沖縄県">沖縄県</option>
        </select>
      </div>

      <div class="center">
        <button id="startButton" disabled>次へ（タイプ選択へ）</button>
      </div>
    </div>
  </section>

  <!-- ステップ1：タイプ選択（次へボタン方式） -->
  <section id="typeSelectSection" class="hidden">
    <h2>まず、好きな焼酎のタイプを教えてください</h2>
    <div class="center type-buttons">
      <button data-type="A">A.芋らしい、スウィート、濃厚</button>
      <button data-type="B">B.芋らしい、スウィート、すっきり</button>
      <button data-type="C">C.フルーティ、すっきり、飲みごたえ</button>
      <button data-type="D">D.フルーティ、すっきり、軽快</button>
    </div>
    <div class="center" style="margin-top: 12px;">
      <button id="typeNextButton" disabled>次へ（問診スタート）</button>
    </div>
  </section>

  <!-- ステップ2：質問表示 -->
  <section id="questionSection" class="hidden">
    <h2 id="currentTypeTitle"></h2>
    <div class="question-box">
      <p id="questionCounter"></p>
      <h3 id="questionText"></h3>
      <div class="answer-buttons center">
        <button data-answer="A" id="answerA"></button>
        <button data-answer="B" id="answerB"></button>
        <button data-answer="C" id="answerC"></button>
      </div>
      <div class="center nav-buttons">
        <button id="backButton">戻る</button>
        <button id="nextButton" disabled>次へ</button>
      </div>
    </div>
  </section>

  <!-- ステップ3：結果表示 -->
  <section id="resultSection" class="hidden">
    <h2>診断結果</h2>
    <div class="result-box">
      <h3 id="resultTitle"></h3>
      <img id="resultImage" alt="診断結果のイメージ">
      <p id="resultText"></p>

      <hr>

      <div class="center">
        <button id="saveTxtButton">回答を保存する</button>

        <p class="small-note">
          ※ 回答結果はこの端末にテキストファイルとして保存され、<br>
          後日、統計・分析の目的で利用されます。
        </p>
      </div>
    </div>

    <div class="center" style="margin-top: 20px;">
      <button id="restartButton">最初に戻る</button>
    </div>
  </section>

  <script>
    // ===== 質問データ（A〜D、各7問） =====
    const questions = {
      A: [
        { text: "理想の飲み会は？", options: { A: "一人で楽しむ、または少人数で会話を楽しむ", B: "料理とお酒をじっくり楽しむ", C: "大人数でワイワイ" } },
        { text: "行ってみたい旅行は？", options: { A: "歴史のある街で伝統文化を堪能", B: "美食を求めて食べ歩き", C: "秘境やあまりみんなが行かない穴場で冒険" } },
        { text: "好きな色の系統は？", options: { A: "深みのある藍色や茶色", B: "淡いパステルカラー", C: "鮮やかなビビッドカラー" } },
        { text: "好きな映画は？", options: { A: "時代劇や歴史映画", B: "ヒューマンドラマ", C: "アクションやSF" } },
        { text: "好きな鹿児島の食べ物は？", options: { A: "さつまあげ", B: "とりさし", C: "しろくま" } },
        { text: "好きな季節は？", options: { A: "春", B: "秋", C: "夏" } },
        { text: "カフェで頼むなら？", options: { A: "深入り珈琲", B: "季節限定のラテ", C: "甘いフラペチーノ" } }
      ],
      B: [
        { text: "飲み会でのあなたは？", options: { A: "地元の話題や思い出話で盛り上げる", B: "周りの話の聞き手役", C: "場をまとめてバランスを取る" } },
        { text: "プレゼントで貰って嬉しいのは？", options: { A: "ご当地の特産品", B: "アロマやハンドクリームなど癒しグッズ", C: "実用的な日用品" } },
        { text: "旅行に行くならどこ？", options: { A: "旅行先の歴史や文化を感じる旅", B: "温泉や自然でのんびり", C: "都会でショッピングやグルメ" } },
        { text: "好きな色の系統は？", options: { A: "温かみのある茶色やオレンジ", B: "やさしいパステルカラー", C: "落ち着いたネイビーやグレー" } },
        { text: "理想の休日は？", options: { A: "地元のイベントや祭りに参加", B: "お家でゆっくり映画や読書", C: "カフェやショッピング" } },
        { text: "好きな教科は？", options: { A: "歴史", B: "家庭科", C: "数学" } },
        { text: "理想の晩酌シーンは？", options: { A: "地元の新鮮な魚と一緒に", B: "お風呂上りにゆったりと", C: "音楽を流しながら上品に" } }
      ],
      C: [
        { text: "好きなドリンクは？", options: { A: "香り高い紅茶や吟醸香の強い清酒", B: "カラフルなカクテル", C: "ハーブティーやオーガニックワイン" } },
        { text: "一番惹かれる言葉は？", options: { A: "新感覚", B: "インスタ映え", C: "自然、天然" } },
        { text: "理想の休日は？", options: { A: "都心部でショッピング", B: "友達や家族と集まってわいわい", C: "空気の良い大自然でリラックス" } },
        { text: "秋と言えば？", options: { A: "食欲の秋", B: "運動の秋", C: "読書の秋" } },
        { text: "好きな空の景色は？", options: { A: "夕焼け空", B: "花火が上がる夜空", C: "霧がかった森の空" } },
        { text: "あなたを動物に例えると？", options: { A: "ライオン", B: "いぬ", C: "うさぎ" } },
        { text: "SNSでよく見るのは？", options: { A: "オシャレカフェや新商品グルメ", B: "イベントやフェス", C: "ていねいな暮らし（収納、ガーデニング）" } }
      ],
      D: [
        { text: "好きなドリンクは？", options: { A: "炭酸水", B: "ミックスジュース", C: "エナジードリンク" } },
        { text: "一番惹かれる言葉は？", options: { A: "新感覚", B: "おすすめ", C: "新商品、限定" } },
        { text: "焼酎を飲むなら？", options: { A: "水割りですっきりと", B: "アレンジカクテル", C: "炭酸割でしゅわっと" } },
        { text: "あなたを動物に例えると？", options: { A: "白鳥", B: "カメレオン", C: "フラミンゴ" } },
        { text: "食べたいいちき串木野グルメは？", options: { A: "まぐろラーメン", B: "いちきポンカレー", C: "魚っち（うおっち）" } },
        { text: "本屋で買うなら？", options: { A: "自己啓発本", B: "漫画、小説", C: "ファッション雑誌" } },
        { text: "新商品を見つけたら？", options: { A: "口コミを見てから吟味", B: "その時の気分次第で試す", C: "すぐに試してSNSにアップ" } }
      ]
    };

    // ===== タイブレーク用の予備質問 =====
    const extraQuestions = {
      A: [
        { text: "焼酎を飲むなら？", options: { A: "黒千代香", B: "薩摩切子", C: "薩摩焼" } },
        { text: "焼酎を選ぶ際にどこで選ぶ？", options: { A: "原料、製法", B: "味わいの好み", C: "デザイン" } }
      ],
      B: [
        { text: "SNSでよく見るのは？", options: { A: "イベント", B: "グルメ系", C: "筋トレ、ヨガ" } },
        { text: "臨時収入があったら何に使いたい？", options: { A: "ふるさと納税やクラファン", B: "家族旅行", C: "貯金に回す" } }
      ],
      C: [
        { text: "友人と接するときに意識していることは？", options: { A: "空気感を大事に", B: "盛り上げ役", C: "自然体" } },
        { text: "好きな音楽は？", options: { A: "メッセージ性のある曲", B: "ノリの良い曲", C: "ヒーリングミュージック" } }
      ],
      D: [
        { text: "服を購入するときに重視するポイントは？", options: { A: "機能性", B: "ブランド", C: "トレンド" } },
        { text: "休みの日にお出かけするなら？", options: { A: "美術館や博物館", B: "気の向くままドライブ", C: "インスタで話題のカフェ" } }
      ]
    };

    // ===== 結果データ（12種類） =====
    const results = {
      "A_A": { title: "職人魂の守護者", image: "images/A_A.png", text: "職人魂の守護者タイプのあなた。\nこだわりや伝統を大事にしながら、じっくりと味わう時間を楽しめる人です。\n\nおすすめの焼酎：\n・赤海童初留取り\n・蔵出し秘蔵酒麦\n・伝兵衛新酒" },
      "A_B": { title: "味わいの探究者", image: "images/A_B.png", text: "味わいの探究者タイプのあなた。\nその日の気分や料理との相性を考えながら、幅広い味わいを楽しみたい人です。\n\nおすすめの焼酎：\n・蔵出し秘蔵酒芋\n・あんず酒\n・隠し蔵" },
      "A_C": { title: "濃厚ハンター", image: "images/A_C.png", text: "濃厚ハンタータイプのあなた。\nインパクトのある香りやコクの深い一本を見つけるのが好きな人です。\n\nおすすめの焼酎：\n・コーン焼酎\n・新酒初蔵仕込\n・海童焼き芋" },

      "B_A": { title: "郷土の語り部", image: "images/B_A.png", text: "郷土の語り部タイプのあなた。\n地元の文化や歴史、人とのつながりを大事にしながら、あたたかい時間を紡いでいく人です。\n\nおすすめの焼酎：\n・海童\n・兼重芋\n・海童 祝の赤" },
      "B_B": { title: "癒しの晩酌家", image: "images/B_B.png", text: "癒しの晩酌家タイプのあなた。\n一日の終わりにほっと一息つける、ゆったりとしたお酒時間を大切にできる人です。\n\nおすすめの焼酎・日本酒：\n・焼みつき芋\n・薩州正宗 純米酒\n・黄麹薩摩富士" },
      "B_C": { title: "安定のコンダクター", image: "images/B_C.png", text: "安定のコンダクタータイプのあなた。\n場の空気を読みながら、みんなが心地よく過ごせるようにバランスを取るのが上手な人です。\n\nおすすめの焼酎：\n・海童祝の赤\n・兼重麦\n・海童" },

      "C_A": { title: "香りの魔術師", image: "images/C_A.png", text: "香りの魔術師タイプのあなた。\n一杯の中にある香りのニュアンスや変化を楽しみ、感性豊かに味わえる人です。\n\nおすすめの焼酎：\n・青海童原酒\n・LABO017\n・海童栗黄金" },
      "C_B": { title: "パーティーの演出家", image: "images/C_B.png", text: "パーティーの演出家タイプのあなた。\nみんなで楽しめるシーン作りや、華やかな一杯で場を盛り上げるのが得意な人です。\n\nおすすめのリキュール・焼酎：\n・ホップのチルグリ\n・赤兎馬柚子酒\n・赤兎馬梅酒" },
      "C_C": { title: "ナチュラル志向の調和者", image: "images/C_C.png", text: "ナチュラル志向の調和者タイプのあなた。\n自然体でいられる心地よさや、素材の良さを活かした味わいを大切にする人です。\n\nおすすめの焼酎：\n・海童初留取り紫\n・マーガオのチルグリ\n・薩摩はやひと" },

      "D_A": { title: "爽快スタイリスト", image: "images/D_A.png", text: "爽快スタイリストタイプのあなた。\nすっきりとした飲み口や、キリっとした印象の一杯で自分らしさを表現する人です。\n\nおすすめの焼酎：\n・赤兎馬\n・海童蒼\n・紫の赤兎馬" },
      "D_B": { title: "直感のアーティスト", image: "images/D_B.png", text: "直感のアーティストタイプのあなた。\nそのときのひらめきや感性を大事にして、新しい味わいにも柔軟に挑戦できる人です。\n\nおすすめの焼酎：\n・赤兎馬玉茜\n・赤兎馬B\n・うかぜ" },
      "D_C": { title: "トレンドキャッチャー", image: "images/D_C.png", text: "トレンドキャッチャータイプのあなた。\n新商品や限定品、話題の一本をいち早くチェックして楽しむのが好きな人です。\n\nおすすめの焼酎・リキュール：\n・LABO016\n・赤兎馬抹茶\n・だいやめ" }
    };

    // ===== 状態管理用変数 =====
    let selectedBaseType = null;  // A/B/C/D
    let currentQuestionIndex = 0; // 0〜6
    let answers = [];             // 通常7問の回答
    let extraAnswers = [];        // 予備質問の回答
    let isTieBreak = false;       // タイブレーク中か
    let tieBreakIndex = 0;        // 予備質問のインデックス

    // 属性
    let demoAge = "";
    let demoGender = "";
    let demoPref = "";

    // 結果確定後に「保存ボタン」で使う
    let lastRecordForSave = null;

    // ===== DOM 取得 =====
    const setupSection = document.getElementById("setupSection");
    const typeSelectSection = document.getElementById("typeSelectSection");
    const questionSection = document.getElementById("questionSection");
    const resultSection = document.getElementById("resultSection");

    const ageSelect = document.getElementById("ageSelect");
    const genderSelect = document.getElementById("genderSelect");
    const prefSelect = document.getElementById("prefSelect");
    const startButton = document.getElementById("startButton");

    const typeNextButton = document.getElementById("typeNextButton");
    const currentTypeTitle = document.getElementById("currentTypeTitle");
    const questionCounter = document.getElementById("questionCounter");
    const questionText = document.getElementById("questionText");
    const answerAButton = document.getElementById("answerA");
    const answerBButton = document.getElementById("answerB");
    const answerCButton = document.getElementById("answerC");
    const nextButton = document.getElementById("nextButton");
    const backButton = document.getElementById("backButton");

    const resultTitle = document.getElementById("resultTitle");
    const resultImage = document.getElementById("resultImage");
    const resultText = document.getElementById("resultText");
    const restartButton = document.getElementById("restartButton");

    const saveTxtButton = document.getElementById("saveTxtButton");

    const answerButtons = document.querySelectorAll(".answer-buttons button");
    const typeButtons = document.querySelectorAll(".type-buttons button");

    // ===== 属性入力：必須チェック =====
    function validateSetup() {
      startButton.disabled = !(ageSelect.value && genderSelect.value && prefSelect.value);
    }
    ageSelect.addEventListener("change", validateSetup);
    genderSelect.addEventListener("change", validateSetup);
    prefSelect.addEventListener("change", validateSetup);

    // ステップ0 → ステップ1
    startButton.addEventListener("click", () => {
      demoAge = ageSelect.value;
      demoGender = genderSelect.value;
      demoPref = prefSelect.value;

      setupSection.classList.add("hidden");
      typeSelectSection.classList.remove("hidden");
    });

    // ===== タイプ選択（次へボタン方式） =====
    typeButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        typeButtons.forEach(b => b.classList.remove("selected"));
        btn.classList.add("selected");
        selectedBaseType = btn.dataset.type;
        typeNextButton.disabled = false;
      });
    });

    typeNextButton.addEventListener("click", () => {
      startQuestions();
    });

    // ===== 回答ボタン（選択＆色変更） =====
    answerButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        const answer = btn.dataset.answer; // "A"/"B"/"C"

        answerButtons.forEach(b => b.classList.remove("selected"));
        btn.classList.add("selected");

        if (!isTieBreak) {
          answers[currentQuestionIndex] = answer;
        } else {
          extraAnswers[tieBreakIndex] = answer;
        }

        nextButton.disabled = false;
      });
    });

    // 次へボタン
    nextButton.addEventListener("click", () => {
      nextButton.disabled = true;

      if (!isTieBreak) {
        if (currentQuestionIndex < questions[selectedBaseType].length - 1) {
          currentQuestionIndex++;
          showQuestion();
        } else {
          const counts = calcCounts(false);
          const unique = findUniqueDominant(counts);
          if (unique) {
            showResult(unique);
          } else {
            isTieBreak = true;
            tieBreakIndex = 0;
            extraAnswers = [];
            showTieBreakQuestion();
          }
        }
      } else {
        const counts = calcCounts(true);
        const unique = findUniqueDominant(counts);
        const extras = extraQuestions[selectedBaseType] || [];

        if (unique) {
          showResult(unique);
        } else if (tieBreakIndex < extras.length - 1) {
          tieBreakIndex++;
          showTieBreakQuestion();
        } else {
          const dominant = chooseDominantWithPriority(counts);
          showResult(dominant);
        }
      }
    });

    // 戻るボタン
    backButton.addEventListener("click", () => {
      nextButton.disabled = false;

      if (!isTieBreak) {
        if (currentQuestionIndex > 0) {
          currentQuestionIndex--;
          showQuestion();
        }
      } else {
        if (tieBreakIndex > 0) {
          tieBreakIndex--;
          showTieBreakQuestion();
        }
      }
    });

    // 最初に戻る（属性入力から）
    restartButton.addEventListener("click", () => {
      resetAll();
      resultSection.classList.add("hidden");
      questionSection.classList.add("hidden");
      typeSelectSection.classList.add("hidden");
      setupSection.classList.remove("hidden");
      validateSetup();
    });

    // ===== TXT保存（手動） =====
    saveTxtButton.addEventListener("click", () => {
      if (!lastRecordForSave) {
        alert("保存するデータがありません。");
        return;
      }
      downloadResultAsTxt(lastRecordForSave);
    });

    function downloadResultAsTxt(record) {
      const lines = [];
      lines.push("推し焼酎診断 回答結果");
      lines.push("----------------------------");
      lines.push(`日時: ${record.timestamp}`);
      lines.push(`年代: ${record.age}`);
      lines.push(`性別: ${record.gender}`);
      lines.push(`お住まい: ${record.prefecture}`);
      lines.push("");
      lines.push(`初期タイプ: ${record.baseType}`);
      lines.push(`最終判定: ${record.resultKey}`);
      lines.push(`結果タイトル: ${record.resultTitle}`);
      lines.push("");
      lines.push(`回答（通常）: ${(record.answers || []).join("")}`);
      lines.push(`回答（延長）: ${(record.extraAnswers || []).join("")}`);
      lines.push("");
      lines.push("※ 本データは統計・分析目的で利用されます。");

      const text = lines.join("\n");

      // ファイル名：YYYYMMDD_都道府県.txt（都道府県は安全な文字だけにする）
      const date = new Date(record.timestamp);
      const ymd =
        date.getFullYear().toString() +
        String(date.getMonth() + 1).padStart(2, "0") +
        String(date.getDate()).padStart(2, "0");

      const safePref = (record.prefecture || "unknown").replace(/[^\wぁ-んァ-ン一-龥]/g, "");
      const filename = `oshishouchu_${ymd}_${safePref}.txt`;

      const blob = new Blob([text], { type: "text/plain;charset=utf-8" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();

      URL.revokeObjectURL(url);
    }

    // ===== 関数群 =====
    function resetAll() {
      selectedBaseType = null;
      currentQuestionIndex = 0;
      answers = [];
      extraAnswers = [];
      isTieBreak = false;
      tieBreakIndex = 0;

      demoAge = "";
      demoGender = "";
      demoPref = "";

      lastRecordForSave = null;

      typeButtons.forEach(b => b.classList.remove("selected"));
      typeNextButton.disabled = true;
    }

    function startQuestions() {
      typeSelectSection.classList.add("hidden");
      questionSection.classList.remove("hidden");
      currentQuestionIndex = 0;
      answers = [];
      extraAnswers = [];
      isTieBreak = false;
      tieBreakIndex = 0;
      showQuestion();
    }

    function clearSelection() {
      answerButtons.forEach(b => b.classList.remove("selected"));
    }

    function restoreSelection(answer) {
      clearSelection();
      if (!answer) return;
      if (answer === "A") answerAButton.classList.add("selected");
      if (answer === "B") answerBButton.classList.add("selected");
      if (answer === "C") answerCButton.classList.add("selected");
    }

    function showQuestion() {
      const qList = questions[selectedBaseType];
      const q = qList[currentQuestionIndex];

      isTieBreak = false;

      currentTypeTitle.textContent = `選択中のタイプ：${selectedBaseType}`;
      questionCounter.textContent = `質問 ${currentQuestionIndex + 1} / ${qList.length}`;
      questionText.textContent = q.text;

      answerAButton.textContent = `A. ${q.options.A}`;
      answerBButton.textContent = `B. ${q.options.B}`;
      answerCButton.textContent = `C. ${q.options.C}`;

      restoreSelection(answers[currentQuestionIndex]);

      nextButton.disabled = typeof answers[currentQuestionIndex] === "undefined";
      backButton.disabled = (currentQuestionIndex === 0);
    }

    function showTieBreakQuestion() {
      const extras = extraQuestions[selectedBaseType] || [];
      const q = extras[tieBreakIndex];

      isTieBreak = true;

      currentTypeTitle.textContent = `選択中のタイプ：${selectedBaseType}（延長戦）`;
      questionCounter.textContent = `延長戦 ${tieBreakIndex + 1} / ${extras.length}`;
      questionText.textContent = q.text;

      answerAButton.textContent = `A. ${q.options.A}`;
      answerBButton.textContent = `B. ${q.options.B}`;
      answerCButton.textContent = `C. ${q.options.C}`;

      restoreSelection(extraAnswers[tieBreakIndex]);

      nextButton.disabled = typeof extraAnswers[tieBreakIndex] === "undefined";
      backButton.disabled = (tieBreakIndex === 0);
    }

    function calcCounts(includeExtra) {
      const count = { A: 0, B: 0, C: 0 };
      answers.forEach(a => { if (count[a] !== undefined) count[a]++; });
      if (includeExtra) {
        extraAnswers.forEach(a => { if (count[a] !== undefined) count[a]++; });
      }
      return count;
    }

    function findUniqueDominant(count) {
      const values = [count.A, count.B, count.C];
      const max = Math.max(...values);
      const winners = [];
      if (count.A === max) winners.push("A");
      if (count.B === max) winners.push("B");
      if (count.C === max) winners.push("C");
      return winners.length === 1 ? winners[0] : null;
    }

    function chooseDominantWithPriority(count) {
      const max = Math.max(count.A, count.B, count.C);
      if (count.A === max) return "A";
      if (count.B === max) return "B";
      return "C";
    }

    function showResult(dominantAnswer) {
      questionSection.classList.add("hidden");
      resultSection.classList.remove("hidden");

      const resultKey = `${selectedBaseType}_${dominantAnswer}`;
      const resultData = results[resultKey];

      if (resultData) {
        resultTitle.textContent = resultData.title;
        resultImage.src = resultData.image;
        resultImage.alt = resultData.title;
        resultText.textContent = resultData.text;
      } else {
        resultTitle.textContent = "結果データが設定されていません";
        resultImage.src = "";
        resultImage.alt = "";
        resultText.textContent = `キー: ${resultKey} に対応する結果が results に存在しません。`;
      }

      // 保存ボタン用のレコードを確定
      lastRecordForSave = {
        timestamp: new Date().toISOString(),
        age: demoAge,
        gender: demoGender,
        prefecture: demoPref,
        baseType: selectedBaseType,
        dominant: dominantAnswer,
        resultKey: resultKey,
        resultTitle: resultData ? resultData.title : "",
        answers: answers.slice(),
        extraAnswers: extraAnswers.slice()
      };
    }

    // 初期表示時に必須判定を反映
    validateSetup();
  </script>
</body>
</html>
